@model IEnumerable<TellStoryTogether.Models.Article>

<section id="main-section">
    @if (Context.User.Identity.IsAuthenticated)
    {
        if (ViewBag.length != 0)
        {
            <div id="title" class="show-label" style="margin-top: 100px">
                <h3 class="ui horizontal divider header">@Model.First().Title</h3>
            </div>
            foreach (var item in Model)
            {
                <div class="show ui center aligned basic segment" style="width: auto; margin-bottom: 0px; padding-bottom: 0px; margin-top: 0px; padding-top: 0px">
                    <div>
                        <div class=" ui justified container segment story-container">
                            <img src="@Url.Content(@item.PictureUrl)" class="img-fluid ui rounded left floated image" style="max-width: 37%; height: auto;">
                            <p class="title-ellipsis">username</p>
                            <p class="text-ellipsis">@item.Text</p>
                            <div class="seen-heart">
                                <div class="ui green label ">
                                    @item.Seen
                                    <i class="universal access icon"></i>
                                </div>
                                <div class="ui green label">
                                    @item.Point
                                    <i class="heart icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }

        <div id="show-create" class="show ui center aligned basic segment" style="width: auto; margin-bottom: 0px; padding-bottom: 0px; margin-top: 50px; padding-top: 10px">

            <div class="ui container segment">
                <div class="row">
                    <div class="col-12 col-md-5 text-left">
                        <div class="ui label" style="margin: 12px">
                            Image
                        </div>
                        <div style="margin: 0px; padding: 0px">
                            <div id="main-cropper" style="margin: 0px; padding: 0px"></div>
                        </div>
                        <div class="ui icon button green" id="divUpload" style="margin-left: 12px">
                            <i class="image icon"></i> Choose File
                        </div>
                        <input type="file" class="ui button green" style="display: none" id="select" value="Choose Image" accept="image/*">
                    </div>
                    <div class="col-12 col-md-7">
                        <div class="text-left row">
                            @if (ViewBag.length == 0)
                            {
                                <div class="col-12">
                                    <div class="ui labeled input" style="margin: 12px">
                                        <div class="ui label">
                                            Title:
                                        </div>
                                        <input id="title" type="text">
                                    </div>
                                </div>
    <div class="col-12 show-title">
        <div class="ui label" style="margin: 12px">
            Character Limit
        </div>
    </div>
                                <div>
                                    <div class="ui labeled input col-3" style="margin: 12px">
                                        <div class="ui label">
                                            Min:
                                        </div>
                                        <input id="min-char" type="number" value="300">
                                    </div>
                                    <div class="ui labeled input col-3" style="margin: 12px">
                                        <div class="ui label">
                                            Max:
                                        </div>
                                        <input id="max-char" type="number" value="2000">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div id="slider-range"></div>
                                </div>
                            }
                            <div class="col-12">
                                <div id="story-title" class="ui label show-title" style="margin: 12px">
                                    Story
                                </div>
                                <textarea id="text" style="text-align: left; vertical-align: top; width: 100%; height: 400px; white-space: pre-line; white-space: pre-wrap;"></textarea>
                                <div id="message-added" class="ui hidden message positive">
                                    <div class="header">
                                        Added
                                    </div>
                                    <p>
                                        Your story is added. You will be redirected to read this story in <span id="second-timer">5</span> seconds.
                                    </p>
                                </div>
                                <div id="message-rejected" class="ui hidden message negative">
                                    <div class="header">
                                        Rejected
                                    </div>
                                    <p>Unfortunately, the story failed to be stored in the server. Please try after five mintues.</p>
                                </div>
                                <div class="text-right col-12">
                                    <div class="ui icon button green" id="upload-button" style="margin: 12px">
                                        <i class="save icon"></i> Save
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div id="message-login" class="ui message" style="margin: 100px">
            <div class="header" style="margin-bottom: 30px">
                Log in or Register
            </div>
            <p>To create new story, you need to <a>@Html.ActionLink("log in here!", "Login", "Account", routeValues: new {returnUrl = "/Create?identifier=@ViewBag.identifier "}, htmlAttributes: new {})</a>
            </p>
            <p>Are you a new user? <a>@Html.ActionLink("Register here!", "Register", "Account", routeValues: new {returnUrl = "/Create?identifier=@ViewBag.identifier "}, htmlAttributes: new {})</a>
            </p>
        </div>
    }
</section>

@section Scripts{
    <script>
    $(document).ready(function() {

        $([document.documentElement, document.body]).animate({
            scrollTop: $("#show-create").offset().top - 60
        }, 2000);

        var basic = $('#main-cropper').croppie({
            viewport: { width: 175, height: 275 },
            boundary: { width: 250, height: 350 },
            showZoomer: false,
            url: 'Images/StoryImage/testFileName.png'

        });

        function readFile(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    $('#main-cropper').croppie('bind', {
                        url: e.target.result
                    });
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        $('#slider-range').slider({
            range: true,
            min: 140,
            max: 4000,
            values: [300, 2000],
            slide: function(event, ui) {
                $("#min-char").val( ui.values[0]);
                $("#max-char").val( ui.values[1]);
            }
        });

        $('#text').on('keyup', function(event) {
            var len = $(this).val().length;
            $('#story-title').html('Story (' +len + ' chars)');
        });

        $("#divUpload").on("click", function() {
            $('#select').click();
        });

        $('#select').on('change', function() { readFile(this); });
        $('#upload-button').on('click', function() {
            basic.croppie('result', 'blob').then(function(blob) {
                var title = "@ViewBag.title";
                var articleInitId = @ViewBag.articleInitId;
                var serial = @ViewBag.serial;
                var min = @ViewBag.charMin;
                var max = @ViewBag.charMax;
                var text = $('#text').val();
                if (@ViewBag.length == 0) {
                    title = $('#title').val();
                    min = $('#min-char').val();
                    max = $('#max-char').val();
                }
                var formData = new FormData();
                formData.append('blob', blob);
                formData.append('title', title);
                formData.append('articleInitId', articleInitId);
                formData.append('text', text);
                formData.append('serial', serial);
                formData.append('min', min);
                formData.append('max', max);

                var myAppUrlSettings = {
                    MyUsefulUrl: '@Url.Action("GetImage", "Create")'
                }

                var request = new XMLHttpRequest();
                request.onload = function() {
                    var response = $.parseJSON(this.responseText);
                    if (response[0] == 'added') {
                        var identifier = "@ViewBag.identifier" + "-" + response[1];
                        var url = '@Url.Action("Index", "Read", new {identifier = "__param__"})';
                        $('#message-added').removeClass('hidden');
                        var counter = 5;
                        var interval = setInterval(function() {
                            counter--;
                            $('#second-timer').html(counter);
                            if (counter == 0) {
                                // Display a login box
                                window.location.href = url.replace('__param__', encodeURIComponent(identifier));
                                clearInterval(interval);
                            }
                        }, 1000);

                    } else {
                        $('#message-rejected').removeClass('hidden');
                    }
                }
                request.open('POST', myAppUrlSettings.MyUsefulUrl);
                request.send(formData);
            });
        });


    });
    </script>
}
    
